# Memory の実装思想

## 論点

Neural Organization の Memory を、組織の「忘れない力」として実現するために、どのような構造・保存形式・アクセスパターン・更新メカニズムで設計するべきか。

## Memory の本質

### なぜ Memory が必要か

従来の組織が抱える最も深刻な構造的問題の一つは「記憶喪失」である。

**問題の構造**:
- 人間の退職・異動により、暗黙知が失われる
- 「あの件の経緯を知っている人はもういない」
- 「前回なぜこの判断をしたか誰も覚えていない」
- 同じ失敗を繰り返す
- 組織改編のたびに知見がリセットされる

これは従来の組織が本質的に解決できない問題である。なぜなら、記憶の主体が「人間の頭」だからである。人間は異動し、退職し、忘れる。

**Neural Organization の解**:

Memory を組織のインフラストラクチャとして外部化する。記憶の主体を「人間」から「システム」に移すことで、組織は人員の変動を超えて知見を保全し続ける。

### Memory の設計原理

**原理 1: Memory は単一のデータベースではない**

Memory は「長期記憶」「作業記憶」「評価記憶」という異なる性質を持つ 3 つの構造と、「層別の永続状態」という 5 つの領域を持つ。これらは異なる技術・異なるアクセスパターンで実装される。

**原理 2: 記憶は関係性のグラフである**

情報は孤立したレコードではなく、相互に関連するグラフとして保持される。「この判断」は「この顧客」の「この問題」に対して「この文脈」で行われた、という関係性が明示的に記録される。

**原理 3: 時間は第一級市民である**

すべての記憶は「いつ発生したか」「いつ観測されたか」「いつ更新されたか」を持つ。これにより、因果関係の推論、トレンド分析、反事実的推論が可能になる。

**原理 4: 忘却は設計される**

人間の記憶と異なり、システムは「何を忘れるか」を能動的に設計できる。重要な記憶は永続し、ノイズは忘却される。この選択的忘却が、記憶の品質を保つ。

**原理 5: 記憶は階層的に抽象化される**

生のイベントログ → パターン → 原則 → 価値観、という階層的な抽象化により、記憶は「使える知見」になる。

## 3 つの記憶構造

### 長期記憶（Institutional Memory）

**時間軸**: 年〜永続

**目的**: 組織が年月をかけて蓄積した知見を保全する。人が入れ替わっても失われない「組織の知恵」。

#### 保存される内容

| カテゴリ | 内容 | 例 |
|---|---|---|
| 成功パターン | うまくいった判断・行動とその文脈 | 「この市場セグメントにはこのメッセージが効く」「このタイプの顧客には早期オンボーディングが重要」 |
| 失敗パターン | うまくいかなかった判断・行動とその原因 | 「この施策は過去 3 回試して全て失敗した。理由は〜」「この判断は短期的には成果が出たが、長期的には負債になった」 |
| 暗黙の価値観 | 明文化されていないが、実際の判断に現れる価値観 | 「この組織は顧客体験を収益よりも優先する傾向がある」「リスクを取るよりも確実性を重視する文化」 |
| 判断基準 | トレードオフの判断において、どの軸を重視するか | 「速度 vs 品質」のトレードオフでは品質を優先する」「コスト削減よりもチームの士気を優先する」 |
| 因果モデル | 組織固有の因果関係の理解 | 「この市場では、価格よりもサポート品質が顧客維持に影響する」「このチームは締め切りが近いほどパフォーマンスが上がる」 |
| 組織の「らしさ」 | この組織を特徴づける行動様式 | 「データに基づいて判断する文化」「失敗を許容し、学習を重視する文化」 |

#### 保存形式

**技術スタック**:
- **グラフデータベース**（Neo4j, Amazon Neptune など）: エンティティ間の関係性を保持
- **ベクトルデータベース**（Pinecone, Weaviate など）: セマンティック検索のため、記憶をベクトル化して保存
- **ドキュメントストア**（MongoDB, PostgreSQL JSONB など）: 構造化されたメタデータと非構造化テキストを保持

**データ構造の例**:

```json
{
  "type": "SuccessPattern",
  "id": "sp_20230415_customer_retention",
  "pattern": "早期オンボーディングの強化が中小企業顧客の維持率を改善する",
  "context": {
    "customerSegment": "SMB (従業員 10-50 名)",
    "problem": "オンボーディング後 30 日での解約率が 25%",
    "action": "専任 CSM による週次チェックイン + 使い方動画の提供",
    "result": "解約率が 25% → 12% に低下",
    "timeframe": "2023-Q1 〜 Q2"
  },
  "confidence": 0.85,
  "applicability": {
    "segments": ["SMB"],
    "constraints": ["リソース: CSM 1 人あたり 15 社まで"]
  },
  "relatedEntities": {
    "customers": ["cust_123", "cust_456", ...],
    "employees": ["emp_cs_01"],
    "initiatives": ["initiative_onboarding_improvement"]
  },
  "createdAt": "2023-07-15T10:30:00Z",
  "lastValidated": "2024-01-20T15:00:00Z",
  "timesApplied": 12,
  "successRate": 0.75
}
```

#### アクセスパターン

**読み取り**:
- **検索**: 「過去に類似した状況で何をしたか？」という文脈ベースの検索
- **想起**: 現在の意思決定に関連する過去のパターンを自動的に想起
- **検証**: 「このパターンは今も有効か？」という検証

**書き込み**:
- **抽出**: Reflection が新たな成功・失敗パターンを検出し、長期記憶に抽出
- **更新**: 既存パターンの信頼度・適用範囲を更新
- **統合**: 複数の類似パターンを統合し、より一般的な原則に昇華

#### 忘却のメカニズム

長期記憶も無限に蓄積するわけではない。以下の基準で忘却が発生する：

| 忘却条件 | 理由 |
|---|---|
| 信頼度が閾値以下 | 適用して失敗を繰り返したパターンは信頼度が低下し、最終的に削除される |
| 適用可能性の消失 | 「この市場セグメントはもう存在しない」など、文脈が消失したパターン |
| より一般的な原則への統合 | 個別パターンが一般原則に抽象化され、個別事例は削除される |
| 人間による明示的な削除 | Custodian が「この記憶は誤りである」と判断した場合 |

ただし、削除される前に「アーカイブ」に移され、必要に応じて復元可能にする。

### 作業記憶（Working Memory）

**時間軸**: 秒〜日

**目的**: 現在進行中のタスク・会話・判断の文脈を保持する。各レイヤーが「いま何をしているか」を記憶する。

#### 保存される内容

| カテゴリ | 内容 | 例 |
|---|---|---|
| 会話文脈 | 人間との対話の履歴・文脈 | 「過去 3 ターンで、顧客 X の解約リスクについて議論している」 |
| タスク状態 | 進行中のタスクの状態 | 「提案書を生成中。現在セクション 3/5 を執筆」 |
| 判断の連鎖 | 一連の判断がどのように導かれたか | 「顧客 Y の健全性が低下 → 原因を分析 → サポート品質が問題と特定 → 改善案を生成中」 |
| 一時的な仮説 | 検証前の暫定的な仮説 | 「売上低下の原因は価格ではなく、競合の新機能かもしれない（未検証）」 |
| 注意の焦点 | 現在システムが注意を向けている対象 | 「顧客 Z の商談がクリティカルフェーズにある。優先的に監視」 |

#### 保存形式

**技術スタック**:
- **インメモリキャッシュ**（Redis, Memcached など）: 高速アクセスのため、頻繁に参照されるデータをメモリに保持
- **ドキュメントストア**（MongoDB など）: 会話履歴、タスク状態などの構造化データ

**データ構造の例**:

```json
{
  "type": "ConversationContext",
  "sessionId": "sess_20240212_143022",
  "participant": "user_governor_01",
  "topic": "Q1 売上目標未達の原因分析",
  "turns": [
    {
      "turn": 1,
      "human": "Q1 の売上が目標に届かなかった原因は？",
      "system": "主要な要因は 3 つ: 1) 大型案件 2 件の遅延...",
      "timestamp": "2024-02-12T14:30:22Z"
    },
    ...
  ],
  "extractedEntities": ["deal_456", "deal_789"],
  "currentFocus": "deal_456 の遅延原因",
  "nextAction": "deal_456 の担当者にヒアリング",
  "expiresAt": "2024-02-13T14:30:22Z"
}
```

#### アクセスパターン

**読み取り**:
- **高頻度**: 会話の各ターンで文脈を参照
- **低レイテンシ**: リアルタイム対話のため、ミリ秒単位の応答が必要

**書き込み**:
- **高頻度**: 会話のたびに更新
- **揮発的**: 会話終了後、一定時間で削除

#### 忘却のメカニズム

作業記憶は短命である。以下の条件で削除される：

| 忘却条件 | タイミング |
|---|---|
| タスク完了 | タスクが完了し、結果が長期記憶に抽出された後 |
| 時間経過 | 最後のアクセスから 24-72 時間経過 |
| 会話終了 | 会話セッションが終了し、重要な情報が長期記憶に抽出された後 |

削除前に、「この作業記憶から長期記憶に抽出すべき知見はあるか？」が評価される。

### 評価記憶（Evaluative Memory）

**時間軸**: 週〜月

**目的**: 目標と現状のギャップ、KPI の推移、行動と結果の対応関係を保持する。Reflection が全層の改善を駆動するためのデータ基盤。

#### 保存される内容

| カテゴリ | 内容 | 例 |
|---|---|---|
| 目標と実績 | 設定された目標と実際の結果 | 「Q1 売上目標: $500K、実績: $420K、達成率: 84%」 |
| KPI の時系列 | 重要指標の推移 | 「顧客維持率: 1 月 88% → 2 月 85% → 3 月 83%（悪化トレンド）」 |
| 行動と結果の対応 | 実行した行動とその結果の因果関係 | 「施策 A を実行 → 2 週間後に指標 X が 15% 改善」 |
| 予測と実績の乖離 | 予測がどれだけ正確だったか | 「顧客 Y の解約を予測（確率 70%）→ 実際に解約」 |
| 判断の品質 | 過去の判断が正しかったか | 「価格変更の判断 → 短期的には売上減だが、長期的には顧客満足度向上」 |

#### 保存形式

**技術スタック**:
- **時系列データベース**（InfluxDB, TimescaleDB など）: KPI の時系列データを効率的に保存・クエリ
- **リレーショナルデータベース**（PostgreSQL など）: 目標・実績・評価の構造化データ

**データ構造の例**:

```json
{
  "type": "ActionOutcomeRecord",
  "id": "ao_20240115_price_change",
  "action": {
    "type": "PriceAdjustment",
    "description": "エンタープライズプランの価格を 20% 引き下げ",
    "decidedAt": "2024-01-15T10:00:00Z",
    "executedAt": "2024-02-01T00:00:00Z",
    "context": {
      "problem": "エンタープライズ顧客の新規獲得が低迷",
      "hypothesis": "価格が競合より 30% 高いことが障壁",
      "expectedOutcome": "新規契約が月 5 件 → 8 件に増加"
    }
  },
  "outcome": {
    "shortTerm": {
      "period": "2024-02 〜 2024-04",
      "metric": "新規契約数",
      "expected": 8,
      "actual": 6,
      "achievement": 0.75
    },
    "longTerm": {
      "period": "2024-02 〜 2024-07",
      "metric": "MRR",
      "expected": "+$50K",
      "actual": "+$35K",
      "achievement": 0.70
    },
    "sideEffects": [
      {
        "metric": "既存顧客の満足度",
        "change": "+5%",
        "note": "既存顧客も自動的に値下げ対象となり、好評"
      }
    ]
  },
  "evaluation": {
    "success": "partial",
    "learnings": [
      "価格は障壁の一つだったが、唯一の障壁ではなかった",
      "競合の機能優位性が依然として影響している",
      "既存顧客への自動適用は予想外のポジティブ効果"
    ],
    "nextActions": [
      "機能ギャップの分析",
      "価格以外の価値訴求の強化"
    ]
  }
}
```

#### アクセスパターン

**読み取り**:
- **定期的**: Reflection が週次・月次で参照
- **分析的**: 「どの行動が効果的だったか」「予測精度はどうか」などの集計・分析クエリ

**書き込み**:
- **バッチ**: 日次・週次でのバッチ更新
- **イベント駆動**: 重要なアウトカムが発生したときに記録

#### 忘却のメカニズム

評価記憶は長期記憶に比べて短命だが、完全には削除されない。

| 忘却条件 | 処理 |
|---|---|
| 長期記憶への昇華 | パターンとして抽出され、長期記憶に移行した後、詳細は圧縮される |
| 一定期間経過 | 1 年以上前のデータは、サマリのみ保持し、詳細は削除 |

## 層別の永続状態

各レイヤーは、自身の動作に必要な永続状態を持つ。これは「そのレイヤーが機能するために必要な記憶」である。

### Layer 0 (Perception) の永続状態

| 状態 | 内容 | 保存形式 |
|---|---|---|
| 接続レジストリ | どのデータソースに接続しているか | リレーショナル DB |
| ソースカタログ | 接続可能なデータソースのカタログ | ドキュメントストア |
| 注意モデル | どのシグナルを重要視するか | 機械学習モデル（パラメータ） |
| シグナルパターン | 過去に検出されたシグナルのパターン | 時系列 DB |

### Layer 1 (Understanding) の永続状態

| 状態 | 内容 | 保存形式 |
|---|---|---|
| 世界モデル | エンティティ・関係性・因果構造 | グラフ DB |
| 予測モデル | 将来の予測を生成するモデル | 機械学習モデル |
| 反実仮想モデル | 「もし〜していたら」の推論モデル | グラフ DB + ルールエンジン |

**世界モデルの中核**:

Layer 1 の世界モデルは、Memory の最も重要な部分である。これは単なるデータベースではなく、「組織の現実についての生きたモデル」である。

```
例: 顧客エンティティ
{
  "entity": "Customer",
  "id": "cust_acme_corp",
  "attributes": {
    "name": "Acme Corp",
    "segment": "Enterprise",
    "mrr": 12000,
    "healthScore": 65,
    "riskLevel": "medium"
  },
  "relationships": {
    "assignedCSM": "emp_cs_sarah",
    "activeDeals": ["deal_expansion_2024"],
    "usesProducts": ["product_platform", "product_analytics"]
  },
  "temporalState": {
    "healthScoreTrend": "declining",
    "usageChanges": [
      {"date": "2024-01", "change": "ログイン頻度 -20%"},
      {"date": "2024-02", "change": "サポートチケット +50%"}
    ]
  },
  "causalLinks": {
    "churnDrivers": [
      {"factor": "usageDecline", "weight": 0.6},
      {"factor": "supportQuality", "weight": 0.3}
    ]
  }
}
```

### Layer 2 (Reasoning) の永続状態

| 状態 | 内容 | 保存形式 |
|---|---|---|
| 判断履歴 | 過去の判断とその根拠 | ドキュメントストア |
| 戦略パターン | 繰り返し使われる戦略の型 | グラフ DB |
| 調整パターン | 領域横断的な調整の成功パターン | グラフ DB |

### Layer 3 (Execution) の永続状態

| 状態 | 内容 | 保存形式 |
|---|---|---|
| ケイパビリティレジストリ | 実行可能なアクションのカタログ | ドキュメントストア |
| 実行ログ | 過去の実行履歴 | 時系列 DB |
| 品質基準 | アウトプットの品質基準 | ドキュメントストア |

### Layer 4 (Reflection) の永続状態

| 状態 | 内容 | 保存形式 |
|---|---|---|
| 学習履歴 | どのような学習が行われたか | ドキュメントストア |
| モデル評価 | 各層のモデルの精度評価 | リレーショナル DB |
| 改善提案 | 生成された改善提案とその状態 | ドキュメントストア |

## 検索と想起

Memory の価値は、「必要なときに必要な記憶を想起できること」にある。

### 検索の種類

| 検索タイプ | 説明 | 技術 |
|---|---|---|
| 構造化クエリ | 「顧客 X の情報」など、明確な条件での検索 | SQL, GraphQL |
| セマンティック検索 | 「過去に類似した状況」など、意味ベースの検索 | ベクトル検索（Embedding） |
| 時系列クエリ | 「KPI の推移」「トレンド」などの時系列分析 | 時系列 DB クエリ |
| グラフトラバーサル | 「この顧客に関連する全エンティティ」など、関係性を辿る検索 | グラフ DB クエリ |

### 想起のメカニズム

人間の記憶と同様、Neural Organization の Memory も「能動的な想起」を行う。

**トリガーベースの想起**:
- 現在の文脈に関連する過去の記憶を自動的に想起
- 例: 「顧客 Y との商談を進めている」→ 「過去の類似商談の成功・失敗パターン」を想起

**連想的な想起**:
- 一つの記憶が別の記憶を連想的に呼び起こす
- 例: 「価格変更を検討している」→ 「過去の価格変更の結果」→ 「価格変更後の顧客反応パターン」→ 「顧客セグメント別の価格感応度」

## 整合性とバージョニング

### 分散記憶の整合性

Memory は複数のデータストアに分散して保存されるため、整合性の維持が重要である。

**結果整合性（Eventual Consistency）の採用**:
- 強整合性は不要（組織の記憶は多少の遅延を許容できる）
- 各ストアは非同期に更新され、最終的に整合性が保たれる

**整合性の境界**:
- 作業記憶内では強整合性（会話の文脈は即座に反映）
- 長期記憶は結果整合性（数分〜数時間の遅延を許容）

### バージョニング

Memory は時間とともに変化する。過去の状態を追跡可能にするため、バージョニングを実装する。

**イベントソーシング**:
- 状態の変化そのものを記録する
- 「顧客 X の健全性スコアは 85 である」ではなく、「2024-02-12 に顧客 X の健全性スコアが 90 から 85 に変化した」を記録
- これにより、任意の時点の状態を再構成可能

## Memory の成長と最適化

### 記憶の成長曲線

Neural Organization の導入初期は、Memory はほぼ空である。時間とともに記憶が蓄積され、システムの知性が向上する。

| フェーズ | 期間 | Memory の状態 | 能力 |
|---|---|---|---|
| 初期（Cold Start） | 0-3 ヶ月 | ほぼ空。作業記憶のみ機能 | 人間の指示に従うのみ。自律性はほぼゼロ |
| 学習期 | 3-12 ヶ月 | 評価記憶が蓄積。いくつかのパターンが抽出される | 繰り返しタスクを学習。予測精度が向上 |
| 成熟期 | 12-36 ヶ月 | 長期記憶が充実。組織固有のパターンが確立 | 自律的な判断が可能。人間の介入が減少 |
| 最適化期 | 36 ヶ月以降 | 記憶が精錬され、ノイズが除去される | 高度な予測・推論。組織の「知恵」として機能 |

### 最適化の継続

Memory は無限に成長するわけではない。定期的な最適化により、品質を保つ。

**最適化の種類**:
- **圧縮**: 古い詳細データをサマリに圧縮
- **統合**: 類似パターンを統合し、より一般的な原則に昇華
- **再評価**: 古いパターンの有効性を再検証
- **忘却**: 信頼度の低い記憶を削除

## まとめ

Neural Organization の Memory は、組織の「忘れない力」の実体である。

**設計の核心**:
1. **3 つの時間軸**: 長期記憶・作業記憶・評価記憶が異なる役割を担う
2. **層別の永続状態**: 各レイヤーが必要な記憶を保持
3. **グラフ構造**: 情報は関係性のグラフとして保持される
4. **時間の明示**: すべての記憶は時間軸を持つ
5. **選択的忘却**: 何を忘れるかを設計する
6. **能動的想起**: 必要な記憶を自動的に想起する

この Memory の上に、Layer 1 (Understanding) の世界モデルが構築され、組織の現実についての深い理解が実現される。
